<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Teste Final - HICD System</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        button { padding: 8px 15px; margin: 5px; background: #007bff; color: white; border: none; cursor: pointer; }
        button:hover { background: #0056b3; }
        #log { background: #f8f9fa; padding: 10px; height: 300px; overflow-y: scroll; border: 1px solid #ddd; }
    </style>
</head>
<body>
    <h1>üöÄ Teste Final - HICD System</h1>
    
    <div class="test-section">
        <h3>Testes de Funcionalidade</h3>
        <button onclick="testMenuNavigation()">1. Testar Navega√ß√£o do Menu</button>
        <button onclick="testClinicasLoading()">2. Testar Carregamento de Cl√≠nicas</button>
        <button onclick="testPacientesByClinica()">3. Testar Pacientes por Cl√≠nica</button>
        <button onclick="testAllAPIs()">4. Testar Todas as APIs</button>
        <button onclick="testCompleteFlow()">5. Teste Completo</button>
        <button onclick="clearLog()">Limpar Log</button>
    </div>
    
    <div class="test-section">
        <h3>Log de Testes</h3>
        <div id="log"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            $('#log').append(`<div class="${className}">[${timestamp}] ${message}</div>`);
            $('#log').scrollTop($('#log')[0].scrollHeight);
            console.log(message);
        }

        function clearLog() {
            $('#log').empty();
        }

        async function testMenuNavigation() {
            log('=== TESTE 1: NAVEGA√á√ÉO DO MENU ===');
            
            try {
                // Testar se a p√°gina principal carrega
                const response = await fetch('http://localhost:8080/index.html');
                if (response.ok) {
                    log('‚úÖ P√°gina principal carregou', 'success');
                    
                    const html = await response.text();
                    
                    // Verificar elementos cr√≠ticos
                    const checks = [
                        { test: html.includes('data-section="clinicas"'), msg: 'Atributo data-section para cl√≠nicas' },
                        { test: html.includes('data-section="pacientes"'), msg: 'Atributo data-section para pacientes' },
                        { test: html.includes('id="clinicasGrid"'), msg: 'Grid de cl√≠nicas' },
                        { test: html.includes('id="clinicaSelect"'), msg: 'Select de cl√≠nicas na se√ß√£o pacientes' },
                        { test: html.includes('id="loadPacientesBtn"'), msg: 'Bot√£o carregar pacientes' }
                    ];
                    
                    checks.forEach(check => {
                        if (check.test) {
                            log(`‚úÖ ${check.msg}`, 'success');
                        } else {
                            log(`‚ùå ${check.msg}`, 'error');
                        }
                    });
                } else {
                    log('‚ùå Erro ao carregar p√°gina principal', 'error');
                }
            } catch (error) {
                log(`‚ùå Erro no teste de navega√ß√£o: ${error.message}`, 'error');
            }
        }

        async function testClinicasLoading() {
            log('=== TESTE 2: CARREGAMENTO DE CL√çNICAS ===');
            
            try {
                const response = await fetch('http://localhost:3000/api/clinicas');
                if (response.ok) {
                    const data = await response.json();
                    const clinicas = data.data || data;
                    
                    log(`‚úÖ ${clinicas.length} cl√≠nicas carregadas`, 'success');
                    log(`üìä Primeira cl√≠nica: ${clinicas[0].nome} (ID: ${clinicas[0].id})`, 'info');
                    
                    // Testar algumas cl√≠nicas espec√≠ficas
                    const testClinicas = clinicas.slice(0, 3);
                    for (const clinica of testClinicas) {
                        try {
                            const pacientesResponse = await fetch(`http://localhost:3000/api/clinicas/${clinica.id}/pacientes`);
                            if (pacientesResponse.ok) {
                                const pacientesData = await pacientesResponse.json();
                                const pacientes = pacientesData.data || pacientesData;
                                log(`‚úÖ Cl√≠nica ${clinica.nome}: ${pacientes.length} pacientes`, 'success');
                            } else {
                                log(`‚ö†Ô∏è Cl√≠nica ${clinica.nome}: Erro ao carregar pacientes`, 'error');
                            }
                        } catch (error) {
                            log(`‚ùå Erro ao testar cl√≠nica ${clinica.nome}: ${error.message}`, 'error');
                        }
                    }
                } else {
                    log('‚ùå Erro ao carregar cl√≠nicas', 'error');
                }
            } catch (error) {
                log(`‚ùå Erro no teste de cl√≠nicas: ${error.message}`, 'error');
            }
        }

        async function testPacientesByClinica() {
            log('=== TESTE 3: PACIENTES POR CL√çNICA ===');
            
            try {
                // Primeiro, pegar uma cl√≠nica v√°lida
                const clinicasResponse = await fetch('http://localhost:3000/api/clinicas');
                const clinicasData = await clinicasResponse.json();
                const clinicas = clinicasData.data || clinicasData;
                
                if (clinicas.length > 0) {
                    const clinica = clinicas[0];
                    log(`üè• Testando cl√≠nica: ${clinica.nome} (ID: ${clinica.id})`, 'info');
                    
                    const pacientesResponse = await fetch(`http://localhost:3000/api/clinicas/${clinica.id}/pacientes`);
                    if (pacientesResponse.ok) {
                        const pacientesData = await pacientesResponse.json();
                        const pacientes = pacientesData.data || pacientesData;
                        
                        log(`‚úÖ ${pacientes.length} pacientes encontrados`, 'success');
                        
                        if (pacientes.length > 0) {
                            const paciente = pacientes[0];
                            log(`üë§ Primeiro paciente: ${paciente.nome} (Prontu√°rio: ${paciente.prontuario})`, 'info');
                            
                            // Verificar campos importantes
                            const campos = ['nome', 'prontuario', 'leito', 'idade'];
                            campos.forEach(campo => {
                                if (paciente[campo]) {
                                    log(`‚úÖ Campo ${campo}: ${paciente[campo]}`, 'success');
                                } else {
                                    log(`‚ö†Ô∏è Campo ${campo}: n√£o encontrado`, 'error');
                                }
                            });
                        }
                    } else {
                        log('‚ùå Erro ao carregar pacientes da cl√≠nica', 'error');
                    }
                } else {
                    log('‚ùå Nenhuma cl√≠nica encontrada', 'error');
                }
            } catch (error) {
                log(`‚ùå Erro no teste de pacientes: ${error.message}`, 'error');
            }
        }

        async function testAllAPIs() {
            log('=== TESTE 4: TODAS AS APIS ===');
            
            const endpoints = [
                { url: '/api/health', name: 'Health Check' },
                { url: '/api/clinicas', name: 'Listar Cl√≠nicas' },
                { url: '/api/clinicas/001/pacientes', name: 'Pacientes da Cl√≠nica 001' }
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`http://localhost:3000${endpoint.url}`);
                    if (response.ok) {
                        const data = await response.json();
                        log(`‚úÖ ${endpoint.name}: OK`, 'success');
                        
                        if (endpoint.url.includes('clinicas') && !endpoint.url.includes('health')) {
                            const items = data.data || data;
                            if (Array.isArray(items)) {
                                log(`üìä ${endpoint.name}: ${items.length} items`, 'info');
                            }
                        }
                    } else {
                        log(`‚ùå ${endpoint.name}: HTTP ${response.status}`, 'error');
                    }
                } catch (error) {
                    log(`‚ùå ${endpoint.name}: ${error.message}`, 'error');
                }
            }
        }

        async function testCompleteFlow() {
            log('=== TESTE 5: FLUXO COMPLETO ===');
            
            try {
                log('üöÄ Iniciando teste completo do sistema...', 'info');
                
                // 1. Testar servidores
                log('1Ô∏è‚É£ Testando servidores...', 'info');
                const frontendOk = await fetch('http://localhost:8080').then(r => r.ok);
                const apiOk = await fetch('http://localhost:3000/api/health').then(r => r.ok);
                
                if (frontendOk && apiOk) {
                    log('‚úÖ Ambos servidores funcionando', 'success');
                } else {
                    log(`‚ùå Servidores: Frontend ${frontendOk ? 'OK' : 'ERRO'}, API ${apiOk ? 'OK' : 'ERRO'}`, 'error');
                    return;
                }
                
                // 2. Testar carregamento de dados
                log('2Ô∏è‚É£ Testando carregamento de dados...', 'info');
                const clinicasData = await fetch('http://localhost:3000/api/clinicas').then(r => r.json());
                const clinicas = clinicasData.data || clinicasData;
                
                if (clinicas.length > 0) {
                    log(`‚úÖ ${clinicas.length} cl√≠nicas dispon√≠veis`, 'success');
                    
                    // 3. Testar pacientes
                    log('3Ô∏è‚É£ Testando pacientes...', 'info');
                    let totalPacientes = 0;
                    
                    for (let i = 0; i < Math.min(3, clinicas.length); i++) {
                        const clinica = clinicas[i];
                        try {
                            const pacientesData = await fetch(`http://localhost:3000/api/clinicas/${clinica.id}/pacientes`).then(r => r.json());
                            const pacientes = pacientesData.data || pacientesData;
                            totalPacientes += pacientes.length;
                            log(`üìä ${clinica.nome}: ${pacientes.length} pacientes`, 'info');
                        } catch (error) {
                            log(`‚ö†Ô∏è Erro na cl√≠nica ${clinica.nome}: ${error.message}`, 'error');
                        }
                    }
                    
                    log(`‚úÖ Total de pacientes testados: ${totalPacientes}`, 'success');
                    
                    // 4. Resumo final
                    log('4Ô∏è‚É£ Resumo do teste...', 'info');
                    log('üéâ TESTE COMPLETO FINALIZADO!', 'success');
                    log(`üìà Resultados: ${clinicas.length} cl√≠nicas, ${totalPacientes} pacientes testados`, 'success');
                    log('üöÄ Sistema HICD est√° funcionando corretamente!', 'success');
                    
                } else {
                    log('‚ùå Nenhuma cl√≠nica encontrada', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro no teste completo: ${error.message}`, 'error');
            }
        }

        // Executar teste inicial
        setTimeout(() => {
            log('üîß Sistema de testes carregado', 'info');
            log('üëÜ Clique nos bot√µes acima para executar os testes', 'info');
        }, 500);
    </script>
</body>
</html>
